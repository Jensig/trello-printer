<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8"/>
  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico"/>
  <title>Trello Printer: Format and print cards from Trello</title>
  <link rel="stylesheet" type="text/css" href="cards.css"/>
  <link href='http://fonts.googleapis.com/css?family=Roboto+Condensed:400,700' rel='stylesheet' type='text/css'>
  <style type="text/css">
    body {
      background-color: #37343A;
      font-family: 'Roboto Condensed', sans-serif;
      color: #fff;
    }

    #header {
      text-align: center;
      margin-top: 75px;
    }

    .board {
      font-size: 1.4em;      
      line-height: 1.6em;
      font-weight: normal;
    }
    #header p {
      margin-top:5px;
      margin-bottom:0;
      padding-bottom:0;
      font-size:4em;
      text-shadow: 1px 1px 1px #000000;
    }

    #header div {
      margin-top:0px;
      line-height: 2em;
      margin-bottom: 25px;
      font-weight: 300;
      font-size: 1.5em;
    }

    #canvas {
      text-align:center;
       margin-bottom: 75px;
    }
    #canvas button {
      border:0;
      background-color: #FCE5A5;
      font-family: 'Roboto Condensed', sans-serif;
      font-size:1.5em;
      color: #37343A;
      border-radius: 6px;
      padding: 0.6em 1em;
      box-shadow: 1px 1px 1px #000000;
    }

    #project-list button {
      font-size: 0.9em;
      padding: 0.3em 0.5em;
      float:right;
    }

    .project {
      clear: both;
    }

    #canvas button:hover {
      background-color: #666;
    }

    .board  {

      font-weight: 300;
    }

    #project-list {
      width: 400px;
      text-align: left;
      margin:  0 auto;
    }
  </style>
</head>
<body>
  <div id="header">
    <img src="logo.png"/>
    <p>Trello Printer</p>
    <div>Format and print cards from Trello</div>
  </div>

  <div id="canvas">
    
  </div>
  <div style="text-align:center">
    <a href="https://twitter.com/share" class="twitter-share-button" data-via="kouphax" data-hashtags="trello">Tweet</a>
  </div>
<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>
  <script src="http://code.jquery.com/jquery-1.7.1.min.js"></script>
  <script src="https://api.trello.com/1/client.js?key=b40154d674db60e94c62a035d0d94684"></script>
  <script src="http://documentcloud.github.com/underscore/underscore-min.js" type="text/javascript"></script>
  <script type="text/javascript">
    (function(){ 

      var body = $('#canvas');

      function showBoards() {
        body.empty().append("<div id='project-list'></div>")

        var list = body.find("#project-list")

        Trello.get('members/me/boards', {filter: 'open'}, function(boards){
          $.each(boards, function(index, board){
            var html = $("<div class='project'><button data-board-id='" + board.id + "' data-board-name='" + board.name + "'>Print Cards</button><div class='board'>" + board.name + "</div></div>")

            list.append(html)
          })

          body.find('.project button').on('click', function(){
            showCards($(this).data("board-id"), $(this).data("board-name"))
          });
        }, handleErrors);
      }

      function showCards(boardId, boardName) {
        Trello.get('boards/' + boardId + '/cards/open', function(cards) {
          print(cards, boardName)
        })
      }

      function print(cards, boardName) {

        var make_front = _.template(
          '<div class="card" id="front-<%= cardno %>">' +
          '  <div class="front side">' +
          '    <div class="header">' +
          '      <span class="labels">' +
          '<% _.each(labels, function(label) { %> <span class="label"><%= label %></span> <% }); %>' +
          '      <span>' +
          '    </div>' +
          '    <div class="middle">' +
          '      <div class="story-title"><%= name %></div>' +
          '    </div>' +
          '    <div class="footer">' +
          '      <span class="points points<%= points %>"><span><%= points || "" %></span></span>' +
          '    </div>' +
          '  </div>' +
          '</div>');

        var make_back = _.template(
          '<div class="card" id="back-<%= cardno %>">' +
          '  <div class="back side">' +
          '    <div class="header">' +
          '      <span class="project"><%= project_name %></span>' +
          '    </div>' +
          '    <div class="middle">' +
          '      <div class="story-title"><%= name %></div>' +
          '      <div class="description"><%= description %></div>' +
          '      <table class="tasks">' +
          '<% _.each(tasks, function(task) { %><tr>' +
          '      <td class="check <%= task.complete ? "complete" : "incomplete" %>"><%= task.complete ? "☑" : "☐" %></td>' +
          '      <td class="task"><%= task.description %></td>' +
          '</tr><% }); %>' +
          '      </table>' +
          '    </div>' +
          '    <div class="footer">' +
          '    </div>' +
          '  </div>' +
          '</div>');

          var fronts      = [];
          var backs       = [];

          $('body > *').hide();

          var main = $('<div id="pivotal-cards-pages" class="filing-colours"></div>');

          $(document).keyup(function(e) {
            if (e.keyCode == 27) { 
              main.remove();
              $('body > *').show();
              $('body').css("background-color", "#37343A")
            } 
          });
          
          $('body').css("background-color", "#fff").append(main);

          var cardCount = cards.length;
          var cardBuildIndex = 0;

          _.each(cards, function(card) {

              var labels = _.chain(card.labels)
                            .map(function(label){ return label.name })
                            .reject(function(label) { return !label; })
                            .value()

              var item = {
                cardno       : card.idShort,
                id           : card.id,
                name         : card.name,
                description  : card.desc,
                project_name : boardName,
                tasks        : [],
                points       : "",
                labels       : labels
              };

              if(card.idChecklists[0]) {
                Trello.checklists.get(card.idChecklists[0], function(checklist){
                  _.each(checklist.checkItems, function(checkItems){
                    item.tasks.push({
                      description: checkItems.name,
                      complete: checkItems.state == 'complete'
                    })
                  })

                  fronts.push($(make_front(item)));
                  backs.push($(make_back(item)));
                  cardBuildIndex++
                }, handleErrors)
              } else {
                cardBuildIndex++
                fronts.push($(make_front(item)));
                backs.push($(make_back(item)));
              }
          })

          var interval = setInterval(function(){
            if(cardCount == cardBuildIndex) {
              clearTimeout(interval);
              printCards();

            }
          }, 100);

          function printCards(){
            var cardno;
            var front_page;
            var back_page;

            for (cardno = 0; cardno < fronts.length; cardno++) {
              if ((cardno % 4) === 0) {
                front_page = $('<div class="page fronts"></div>');
                main.append(front_page);

                back_page = $('<div class="page backs"></div>');
                main.append(back_page);
              }
              front_page.append(fronts[cardno]);
              back_page.append(backs[cardno]);
            }

            window.print();
          }
      }

      function onAuthorize() {

        showBoards();

      }

      function auth() {
        Trello.authorize({
          type       : "redirect",
          success    : onAuthorize,
          name       : "Trello Cards",
          expiration : "1hour",            
          persist    : true
        })        
      }



      function handleErrors(xhr, message, error) {

        if(xhr.status == 401) {
          Trello.deauthorize()
          auth()
        }
        console.log(arguments)
      }

      if(/[&#]?token=([0-9a-f]{64})/.test(location.hash)){
        auth()
      } else {
        var authoriseButton = $('<button id="authorise">Authorise with Trello</button>').on('click', function(){
          if(Trello.authorized()){
            onAuthorize()
          } else {
            auth()
          }
        })
        body.append(authoriseButton)
      }
    })()
  </script>
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-19143623-17', 'yobriefca.se');
    ga('send', 'pageview');

  </script>
</body>
</html>
